<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Monitor - Chainat MQTT</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .card h2 { font-size: 1.1rem; margin-bottom: 20px; color: #00d2ff; }
        .sensor-val { font-size: 3rem; font-weight: bold; font-family: 'Courier New', monospace; }
        .temp-color { color: #ff4b2b; }
        .humi-color { color: #00d2ff; }
        .digital-clock { font-size: 3.5rem; text-align: center; color: #4ecca3; font-weight: bold; }
        .chart-container { grid-column: 1 / -1; height: 450px; }
        #mqtt-status { font-size: 0.8rem; float: right; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #4ecca3; box-shadow: 0 0 10px #4ecca3; }
        .offline { background-color: #ff416c; }
    </style>
</head>
<body>

<div class="container">
    <div class="main-grid">
        <div class="card">
            <span id="mqtt-status"><span class="dot offline" id="status-dot"></span>Connecting...</span>
            <h2>üå°Ô∏è Live IoT Sensors</h2>
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div>
                    <div class="sensor-val temp-color" id="txt-temp">--</div>
                    <div style="opacity: 0.7;">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)</div>
                </div>
                <div>
                    <div class="sensor-val humi-color" id="txt-humi">--</div>
                    <div style="opacity: 0.7;">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>‚è∞ Time</h2>
            <div class="digital-clock" id="clock">00:00:00</div>
            <div id="date" style="text-align: center; opacity: 0.6; margin-top: 10px;">--</div>
        </div>

        <div class="card chart-container">
            <h2>üìä Real-time Sensor Data (Temp vs Humidity)</h2>
            <div style="height: 350px;">
                <canvas id="sensorChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Clock
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString('th-TH');
        document.getElementById('date').textContent = now.toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long' });
    }
    setInterval(updateClock, 1000);

    // 2. Chart Setup
    const ctx = document.getElementById('sensorChart').getContext('2d');
    const MAX_POINTS = 20;
    const sensorChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Temperature (¬∞C)',
                    data: [],
                    borderColor: '#ff4b2b',
                    backgroundColor: 'rgba(255, 75, 43, 0.1)',
                    yAxisID: 'yTemp',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Humidity (%)',
                    data: [],
                    borderColor: '#00d2ff',
                    backgroundColor: 'rgba(0, 210, 255, 0.1)',
                    yAxisID: 'yHumi',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                yTemp: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'Temperature (¬∞C)', color: '#ff4b2b' },
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#ff4b2b' }
                },
                yHumi: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'Humidity (%)', color: '#00d2ff' },
                    grid: { drawOnChartArea: false },
                    ticks: { color: '#00d2ff' }
                },
                x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#aaa' } }
            },
            plugins: {
                legend: { labels: { color: 'white' } }
            }
        }
    });

    function addData(time, temp, humi) {
        if (sensorChart.data.labels.length >= MAX_POINTS) {
            sensorChart.data.labels.shift();
            sensorChart.data.datasets[0].data.shift();
            sensorChart.data.datasets[1].data.shift();
        }
        sensorChart.data.labels.push(time);
        sensorChart.data.datasets[0].data.push(temp);
        sensorChart.data.datasets[1].data.push(humi);
        sensorChart.update();
    }

    // 3. MQTT Setup
    const MQTT_CONFIG = {
        host: "1775d011329846b5a98c94a70f743969.s1.eu.hivemq.cloud",
        port: 8884, // WebSocket Port
        user: "dpnine",
        pass: "nayNAY08",
        topic: "home/sensor",
        clientId: "web_monitor_" + Math.random().toString(16).substr(2, 5)
    };

    const client = new Paho.MQTT.Client(MQTT_CONFIG.host, MQTT_CONFIG.port, MQTT_CONFIG.clientId);

    client.onMessageArrived = (msg) => {
        try {
            const data = JSON.parse(msg.payloadString);
            const time = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            document.getElementById('txt-temp').textContent = data.temp;
            document.getElementById('txt-humi').textContent = data.humidity;
            
            addData(time, data.temp, data.humidity);
        } catch(e) { console.error("Data error", e); }
    };

    client.onConnectionLost = () => {
        document.getElementById('status-dot').className = "dot offline";
        document.getElementById('mqtt-status').lastChild.textContent = " Disconnected";
        setTimeout(connect, 5000);
    };

    function connect() {
        client.connect({
            onSuccess: () => {
                document.getElementById('status-dot').className = "dot online";
                document.getElementById('mqtt-status').lastChild.textContent = " Online";
                client.subscribe(MQTT_CONFIG.topic);
            },
            onFailure: () => setTimeout(connect, 5000),
            userName: MQTT_CONFIG.user,
            password: MQTT_CONFIG.pass,
            useSSL: true
        });
    }
    connect();
</script>
</body>
</html>
