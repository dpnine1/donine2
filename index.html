<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Control (2 Relays)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Outfit', sans-serif; }
        .bg-gradient-premium { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }
        .power-btn { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .power-btn.on { background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 0 25px rgba(16, 185, 129, 0.6); border-color: transparent; transform: scale(1.05); }
        .power-btn.off { background: #f1f5f9; color: #94a3b8; box-shadow: inset 0 2px 4px rgba(0,0,0,0.06); }
        .tab-btn.active { background-color: #4f46e5; color: white; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 pb-20">

    <!-- Navbar Background -->
    <div class="fixed top-0 left-0 w-full h-64 bg-gradient-to-r from-indigo-600 to-blue-500 rounded-b-[3rem] shadow-lg -z-10"></div>

    <div class="max-w-6xl mx-auto px-4 pt-12">
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-12 text-white">
            <div>
                <h1 class="text-4xl font-bold tracking-tight">Dashboard (2 Relays)</h1>
                <p class="text-indigo-100 mt-1 font-light">ควบคุม Relay 1 (GPIO 19) และ Relay 2 (GPIO 18)</p>
            </div>
            <div id="status-badge" class="px-5 py-2 bg-white/20 backdrop-blur-md rounded-full text-sm font-medium flex items-center gap-2 border border-white/30">
                <span class="animate-pulse">●</span> Connecting...
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left: Sensors (Same as before) -->
            <div class="lg:col-span-8 flex flex-col gap-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card p-6 rounded-3xl relative overflow-hidden">
                        <p class="text-slate-500 text-sm font-medium mb-1"><i class="fa-solid fa-temperature-half text-orange-500 mr-2"></i>อุณหภูมิ</p>
                        <h2 id="latest-temp" class="text-5xl font-bold text-slate-800">-- <span class="text-xl text-slate-400">°C</span></h2>
                    </div>
                    <div class="glass-card p-6 rounded-3xl relative overflow-hidden">
                        <p class="text-slate-500 text-sm font-medium mb-1"><i class="fa-solid fa-droplet text-blue-500 mr-2"></i>ความชื้น</p>
                        <h2 id="latest-hum" class="text-5xl font-bold text-slate-800">-- <span class="text-xl text-slate-400">%</span></h2>
                    </div>
                </div>
                <div class="glass-card p-6 rounded-3xl flex-1 min-h-[300px]">
                    <canvas id="sensorChart"></canvas>
                </div>
            </div>

            <!-- Right: Control Panel (Updated for 2 Relays) -->
            <div class="lg:col-span-4">
                <div class="glass-card p-6 rounded-3xl h-full flex flex-col relative overflow-hidden">
                    
                    <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-sliders text-indigo-500"></i> Relay Control
                    </h3>

                    <!-- Relay Selection Tabs -->
                    <div class="flex p-1 bg-slate-100 rounded-xl mb-6">
                        <button onclick="switchTab('relay_1')" id="tab-relay_1" class="tab-btn active flex-1 py-2 rounded-lg text-sm font-semibold transition-all">Relay 1</button>
                        <button onclick="switchTab('relay_2')" id="tab-relay_2" class="tab-btn flex-1 py-2 rounded-lg text-sm font-semibold text-slate-500 transition-all">Relay 2</button>
                    </div>

                    <!-- Mode Toggle -->
                    <div class="bg-slate-50 p-1.5 rounded-2xl flex mb-6 border border-slate-100">
                        <button onclick="setMode('manual')" id="btn-manual" class="flex-1 py-2 rounded-xl text-sm font-semibold transition-all bg-white shadow-sm text-indigo-600">Manual</button>
                        <button onclick="setMode('auto')" id="btn-auto" class="flex-1 py-2 rounded-xl text-sm font-semibold transition-all text-slate-400">Auto</button>
                    </div>

                    <!-- Controls Container -->
                    <div id="panel-manual" class="flex-1 flex flex-col items-center justify-center py-4">
                        <div class="relative group cursor-pointer" onclick="toggleRelay()">
                            <button id="btn-relay-toggle" class="power-btn off w-32 h-32 rounded-full border-4 border-slate-50 bg-white text-slate-300 flex items-center justify-center text-4xl shadow-xl z-10 relative">
                                <i class="fa-solid fa-power-off"></i>
                            </button>
                        </div>
                        <p id="relay-status-text" class="text-2xl font-bold text-slate-300 mt-4">CLOSED</p>
                    </div>

                    <div id="panel-auto" class="hidden flex-1 flex flex-col gap-4">
                        <div class="bg-white p-3 rounded-xl border border-slate-100">
                            <label class="text-xs font-bold text-green-600 block mb-1">ON Time</label>
                            <input type="time" id="timer-on" onchange="updateTimer()" class="w-full text-lg font-bold text-slate-700 bg-transparent border-none p-0 focus:ring-0">
                        </div>
                        <div class="bg-white p-3 rounded-xl border border-slate-100">
                            <label class="text-xs font-bold text-red-500 block mb-1">OFF Time</label>
                            <input type="time" id="timer-off" onchange="updateTimer()" class="w-full text-lg font-bold text-slate-700 bg-transparent border-none p-0 focus:ring-0">
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, query, orderBy, limit, onSnapshot, where, Timestamp, setDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCO_62NI-RwdgdkANDxG71o0MJH7wd2CFE",
            authDomain: "dpcloud-67cdb.firebaseapp.com",
            projectId: "dpcloud-67cdb",
            storageBucket: "dpcloud-67cdb.firebasestorage.app",
            messagingSenderId: "207464024544",
            appId: "1:207464024544:web:7affe28fde0088a374c385"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- State Management ---
        let activeRelayId = "relay_1"; // Default active tab
        let relayData = {
            relay_1: { mode: 'manual', state: false, timerOn: "18:00", timerOff: "06:00" },
            relay_2: { mode: 'manual', state: false, timerOn: "18:00", timerOff: "06:00" }
        };

        // --- Tab Switching Logic ---
        window.switchTab = (relayId) => {
            activeRelayId = relayId;
            
            // Update Tab UI
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'text-white'));
            document.getElementById(`tab-${relayId}`).classList.add('active', 'bg-indigo-600', 'text-white');
            document.getElementById(`tab-${relayId}`).classList.remove('text-slate-500');

            // Refresh UI with data for this relay
            updateUI(); 
        }

        // --- Firebase Listener for BOTH Relays ---
        function setupListeners() {
            ['relay_1', 'relay_2'].forEach(id => {
                onSnapshot(doc(db, "controls", id), (docSnap) => {
                    if (docSnap.exists()) {
                        relayData[id] = docSnap.data();
                        if (activeRelayId === id) updateUI(); // Update only if currently viewing
                    } else {
                        setDoc(doc(db, "controls", id), relayData[id]); // Init if missing
                    }
                });
            });
        }

        function updateUI() {
            const data = relayData[activeRelayId];
            const btnManual = document.getElementById('btn-manual');
            const btnAuto = document.getElementById('btn-auto');
            const panelManual = document.getElementById('panel-manual');
            const panelAuto = document.getElementById('panel-auto');
            
            // Update Mode UI
            if (data.mode === 'manual') {
                btnManual.className = "flex-1 py-2 rounded-xl text-sm font-bold bg-white text-indigo-600 shadow-sm transition-all";
                btnAuto.className = "flex-1 py-2 rounded-xl text-sm font-medium text-slate-400 hover:text-slate-600 transition-all";
                panelManual.classList.remove('hidden');
                panelAuto.classList.add('hidden');
            } else {
                btnAuto.className = "flex-1 py-2 rounded-xl text-sm font-bold bg-white text-indigo-600 shadow-sm transition-all";
                btnManual.className = "flex-1 py-2 rounded-xl text-sm font-medium text-slate-400 hover:text-slate-600 transition-all";
                panelManual.classList.add('hidden');
                panelAuto.classList.remove('hidden');
            }

            // Update Manual Button
            const btn = document.getElementById('btn-relay-toggle');
            const txt = document.getElementById('relay-status-text');
            if (data.state) {
                btn.className = "power-btn on w-32 h-32 rounded-full text-white flex items-center justify-center text-5xl z-10 relative cursor-pointer";
                txt.innerText = "OPENING";
                txt.className = "text-2xl font-bold text-green-500";
            } else {
                btn.className = "power-btn off w-32 h-32 rounded-full border-4 border-slate-50 bg-white text-slate-300 flex items-center justify-center text-5xl shadow-md z-10 relative cursor-pointer";
                txt.innerText = "CLOSED";
                txt.className = "text-2xl font-bold text-slate-300";
            }

            // Update Auto Inputs
            document.getElementById('timer-on').value = data.timerOn || "00:00";
            document.getElementById('timer-off').value = data.timerOff || "00:00";
        }

        // --- Actions ---
        window.setMode = async (mode) => {
            await setDoc(doc(db, "controls", activeRelayId), { mode: mode }, { merge: true });
        };

        window.toggleRelay = async () => {
            if (relayData[activeRelayId].mode === 'auto') return;
            const newState = !relayData[activeRelayId].state;
            await setDoc(doc(db, "controls", activeRelayId), { state: newState }, { merge: true });
        };

        window.updateTimer = async () => {
            const tOn = document.getElementById('timer-on').value;
            const tOff = document.getElementById('timer-off').value;
            await setDoc(doc(db, "controls", activeRelayId), { timerOn: tOn, timerOff: tOff }, { merge: true });
        };

        // --- Init (Chart & Auth) ---
        // (ส่วน Chart เหมือนเดิม ละไว้ในฐานที่เข้าใจ หรือใส่โค้ดเต็มได้ถ้าต้องการ)
        function initChart() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Temp', data: [], borderColor: '#f97316' }, { label: 'Humid', data: [], borderColor: '#3b82f6' }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#f1f5f9' } } } }
            });
            
            // เพิ่มการโหลดข้อมูล Sensor (LoadSensorData) ตามโค้ดเดิมที่นี่...
             const loadSensorData = () => {
                const q = query(collection(db, "sensor_logs"), orderBy("timestamp", "desc"), limit(30));
                onSnapshot(q, (snap) => {
                    const data = [];
                    snap.forEach(d => data.push(d.data()));
                    data.sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
                    if(data.length > 0) {
                        const last = data[data.length-1];
                        document.getElementById('latest-temp').innerHTML = `${last.temperature.toFixed(1)} <span class="text-xl text-slate-400">°C</span>`;
                        document.getElementById('latest-hum').innerHTML = `${last.humidity.toFixed(1)} <span class="text-xl text-slate-400">%</span>`;
                        document.getElementById('status-badge').innerHTML = `<span class="text-green-400">●</span> Online`;
                    }
                });
            };
            loadSensorData();
        }

        initChart();
        signInAnonymously(auth).then(setupListeners);

    </script>
</body>
</html>
