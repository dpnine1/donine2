<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, limit, onSnapshot, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ==========================================
    // 1. นำ Web Config จริงมาใส่ตรงนี้ (ห้ามใช้ Private Key)
    // ==========================================
    const firebaseConfig = {
        apiKey: "AIzaSyCO_62NI-RwdgdkANDxG71o0MJH7wd2CFE", // คัดลอกมาจาก Firebase Console
        authDomain: "dpcloud-67cdb.firebaseapp.com",
        projectId: "dpcloud-67cdb",
        storageBucket: "dpcloud-67cdb.firebasestorage.app",
        messagingSenderId: "207464024544",
        appId: "1:207464024544:web:7affe28fde0088a374c385",
        measurementId: "G-7S49QQ638W"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // [ส่วนของ Chart.js และ ฟังก์ชัน calculateStartTime ใช้โค้ดเดิมของคุณได้เลย]
    // ... (โค้ดส่วนตั้งค่ากราฟ) ...

    // ==========================================
    // 3. ปรับปรุง loadData เพื่อให้เรียงลำดับเวลาบนกราฟถูกต้อง
    // ==========================================
    function loadData(range) {
        if (unsubscribe) { unsubscribe(); }

        const statusBadge = document.getElementById('status-badge');
        statusBadge.innerHTML = `<span class="animate-spin h-4 w-4 border-2 border-slate-500 border-t-transparent rounded-full"></span> กำลังโหลด...`;

        let q;
        if (range === 'realtime') {
            q = query(collection(db, "sensor_logs"), orderBy("timestamp", "desc"), limit(50));
        } else {
            const startTime = calculateStartTime(range);
            q = query(
                collection(db, "sensor_logs"), 
                where("timestamp", ">=", startTime), 
                orderBy("timestamp", "desc"), 
                limit(1000)
            );
        }

        unsubscribe = onSnapshot(q, (snapshot) => {
            const rawData = [];
            snapshot.forEach((doc) => {
                rawData.push(doc.data());
            });

            // เรียงข้อมูลจาก อดีต -> ปัจจุบัน เพื่อให้กราฟแสดงผลจากซ้ายไปขวา
            const sortedData = rawData.sort((a, b) => a.timestamp.seconds - b.timestamp.seconds);

            const labels = [];
            const tempData = [];
            const humData = [];

            sortedData.forEach((data) => {
                const dateObj = data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp);
                const format = ['24h', '3d', '7d', '1M', '3M'].includes(range) ? 'DD/MM HH:mm' : 'HH:mm:ss';
                
                labels.push(moment(dateObj).format(format));
                tempData.push(data.temperature);
                humData.push(data.humidity);
            });

            // อัปเดตตัวเลขล่าสุด (ใช้ข้อมูลตัวสุดท้ายที่เพิ่งได้มา)
            if (sortedData.length > 0) {
                const last = sortedData[sortedData.length - 1];
                document.getElementById('latest-temp').innerHTML = `${last.temperature.toFixed(1)} <span class="text-3xl text-slate-400 font-medium">°C</span>`;
                document.getElementById('latest-hum').innerHTML = `${last.humidity.toFixed(1)} <span class="text-3xl text-slate-400 font-medium">%</span>`;
                const updateText = `อัปเดตล่าสุด: ${moment().format('HH:mm:ss')}`;
                document.getElementById('time-temp').innerText = updateText;
                document.getElementById('time-hum').innerText = updateText;
            }

            sensorChart.data.labels = labels;
            sensorChart.data.datasets[0].data = tempData;
            sensorChart.data.datasets[1].data = humData;
            sensorChart.update();

            statusBadge.innerHTML = `<span class="relative flex h-3 w-3"><span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span></span> ออนไลน์ (${snapshot.size} รายการ)`;
            statusBadge.className = 'px-4 py-2 bg-green-50 text-green-700 rounded-full text-sm font-semibold flex items-center gap-2 border border-green-200';
        });
    }

    // [ส่วนจัดการปุ่มกดและ signInAnonymously ใช้โค้ดเดิมของคุณได้เลย]
</script>
