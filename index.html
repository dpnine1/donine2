<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Farm Control Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Prompt', sans-serif; background-color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
    </style>
</head>
<body class="text-slate-800">

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-slate-800"><i class="fas fa-leaf text-green-500 mr-2"></i>Smart Farm Control</h1>
                <p class="text-slate-500 text-sm">ระบบควบคุมและติดตามสถานะฟาร์มอัจฉริยะ</p>
            </div>
            <div id="connection-status" class="px-3 py-1 bg-gray-200 rounded-full text-xs font-semibold text-gray-600 flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-gray-400"></span> Offline
            </div>
        </div>

        <!-- Sensor Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Temp -->
            <div class="glass p-6 rounded-2xl shadow-sm relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-10 text-orange-500"><i class="fas fa-temperature-high text-6xl"></i></div>
                <h3 class="text-orange-600 font-semibold text-sm uppercase">Temperature</h3>
                <div class="flex items-baseline gap-2 mt-2">
                    <span id="val-temp" class="text-5xl font-bold text-slate-800">--</span>
                    <span class="text-xl text-slate-400">°C</span>
                </div>
            </div>
            <!-- Humidity -->
            <div class="glass p-6 rounded-2xl shadow-sm relative overflow-hidden">
                <div class="absolute right-0 top-0 p-4 opacity-10 text-blue-500"><i class="fas fa-tint text-6xl"></i></div>
                <h3 class="text-blue-600 font-semibold text-sm uppercase">Humidity</h3>
                <div class="flex items-baseline gap-2 mt-2">
                    <span id="val-humid" class="text-5xl font-bold text-slate-800">--</span>
                    <span class="text-xl text-slate-400">%</span>
                </div>
            </div>
        </div>

        <!-- Relay Control Section -->
        <h2 class="text-xl font-bold mb-4 text-slate-700"><i class="fas fa-power-off mr-2"></i>Control Panel (Relay)</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            
            <!-- Relay 1 Card -->
            <div class="glass p-6 rounded-2xl shadow-lg border-l-4 border-indigo-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-indigo-700">Relay 1 (Pin 18)</h3>
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button onclick="setMode('r1', 'manual')" id="btn-r1-manual" class="px-3 py-1 text-xs rounded-md font-medium transition-all">Manual</button>
                        <button onclick="setMode('r1', 'auto')" id="btn-r1-auto" class="px-3 py-1 text-xs rounded-md font-medium transition-all">Auto</button>
                    </div>
                </div>

                <!-- Manual UI -->
                <div id="ui-r1-manual" class="text-center py-4">
                    <button id="btn-r1-toggle" onclick="toggleRelay('r1')" class="w-full py-4 rounded-xl font-bold text-xl transition-all shadow-md flex items-center justify-center gap-3">
                        <i class="fas fa-power-off"></i> <span>OFF</span>
                    </button>
                    <p class="text-xs text-slate-400 mt-2">กดเพื่อ เปิด/ปิด ทันที</p>
                </div>

                <!-- Auto UI -->
                <div id="ui-r1-auto" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">เวลาเปิด (ON)</label>
                            <input type="time" id="time-r1-on" onchange="updateTimer('r1')" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-center font-bold text-slate-700">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">เวลาปิด (OFF)</label>
                            <input type="time" id="time-r1-off" onchange="updateTimer('r1')" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-center font-bold text-slate-700">
                        </div>
                    </div>
                    <div class="text-center text-xs text-indigo-500 font-medium bg-indigo-50 p-2 rounded-lg">
                        <i class="fas fa-clock mr-1"></i> ระบบจะทำงานตามเวลาที่ตั้งไว้อัตโนมัติ
                    </div>
                </div>
            </div>

            <!-- Relay 2 Card -->
            <div class="glass p-6 rounded-2xl shadow-lg border-l-4 border-pink-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-pink-700">Relay 2 (Pin 19)</h3>
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button onclick="setMode('r2', 'manual')" id="btn-r2-manual" class="px-3 py-1 text-xs rounded-md font-medium transition-all">Manual</button>
                        <button onclick="setMode('r2', 'auto')" id="btn-r2-auto" class="px-3 py-1 text-xs rounded-md font-medium transition-all">Auto</button>
                    </div>
                </div>

                <!-- Manual UI -->
                <div id="ui-r2-manual" class="text-center py-4">
                    <button id="btn-r2-toggle" onclick="toggleRelay('r2')" class="w-full py-4 rounded-xl font-bold text-xl transition-all shadow-md flex items-center justify-center gap-3">
                        <i class="fas fa-power-off"></i> <span>OFF</span>
                    </button>
                    <p class="text-xs text-slate-400 mt-2">กดเพื่อ เปิด/ปิด ทันที</p>
                </div>

                <!-- Auto UI -->
                <div id="ui-r2-auto" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">เวลาเปิด (ON)</label>
                            <input type="time" id="time-r2-on" onchange="updateTimer('r2')" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-center font-bold text-slate-700">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 block mb-1">เวลาปิด (OFF)</label>
                            <input type="time" id="time-r2-off" onchange="updateTimer('r2')" class="w-full bg-slate-50 border border-slate-200 rounded-lg p-2 text-center font-bold text-slate-700">
                        </div>
                    </div>
                    <div class="text-center text-xs text-pink-500 font-medium bg-pink-50 p-2 rounded-lg">
                        <i class="fas fa-clock mr-1"></i> ระบบจะทำงานตามเวลาที่ตั้งไว้อัตโนมัติ
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="glass p-6 rounded-2xl shadow-sm h-80">
            <canvas id="sensorChart"></canvas>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCO_62NI-RwdgdkANDxG71o0MJH7wd2CFE",
            authDomain: "dpcloud-67cdb.firebaseapp.com",
            projectId: "dpcloud-67cdb",
            storageBucket: "dpcloud-67cdb.firebasestorage.app",
            messagingSenderId: "207464024544",
            appId: "1:207464024544:web:7affe28fde0088a374c385"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // Get correct App ID for path construction
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Global State
        let relayState = {
            r1_mode: 'manual', r1_manual: false, r1_on: "18:00", r1_off: "06:00",
            r2_mode: 'manual', r2_manual: false, r2_on: "18:00", r2_off: "06:00"
        };

        // --- Controller Logic ---
        window.setMode = (relay, mode) => {
            const updates = {};
            updates[`${relay}_mode`] = mode;
            saveConfig(updates);
        };

        window.toggleRelay = (relay) => {
            const current = relayState[`${relay}_manual`];
            const updates = {};
            updates[`${relay}_manual`] = !current;
            saveConfig(updates);
        };

        window.updateTimer = (relay) => {
            const onTime = document.getElementById(`time-${relay}-on`).value;
            const offTime = document.getElementById(`time-${relay}-off`).value;
            const updates = {};
            updates[`${relay}_on`] = onTime;
            updates[`${relay}_off`] = offTime;
            saveConfig(updates);
        };

        async function saveConfig(updates) {
            // Merge updates to local state immediately for UI responsiveness
            relayState = { ...relayState, ...updates };
            renderUI(); 
            // Save to Firestore using SAFE PATH
            // Path: artifacts/{appId}/public/data/config/relays
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'relays'), updates, { merge: true });
            } catch (err) {
                console.error("Error saving config:", err);
                alert("บันทึกไม่สำเร็จ: Permission Denied");
            }
        }

        function renderUI() {
            ['r1', 'r2'].forEach(r => {
                // Mode Buttons
                const isManual = relayState[`${r}_mode`] === 'manual';
                const btnManual = document.getElementById(`btn-${r}-manual`);
                const btnAuto = document.getElementById(`btn-${r}-auto`);
                const uiManual = document.getElementById(`ui-${r}-manual`);
                const uiAuto = document.getElementById(`ui-${r}-auto`);

                btnManual.className = `px-3 py-1 text-xs rounded-md font-medium transition-all ${isManual ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400 hover:text-slate-600'}`;
                btnAuto.className = `px-3 py-1 text-xs rounded-md font-medium transition-all ${!isManual ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400 hover:text-slate-600'}`;

                uiManual.classList.toggle('hidden', !isManual);
                uiAuto.classList.toggle('hidden', isManual);

                // Manual Toggle Button Style
                const btnToggle = document.getElementById(`btn-${r}-toggle`);
                const isOn = relayState[`${r}_manual`];
                const colorClass = r === 'r1' ? 'indigo' : 'pink';
                
                if(isOn) {
                    btnToggle.className = `w-full py-4 rounded-xl font-bold text-xl transition-all shadow-md flex items-center justify-center gap-3 bg-${colorClass}-500 text-white shadow-${colorClass}-200`;
                    btnToggle.innerHTML = `<i class="fas fa-power-off"></i> <span>ON</span>`;
                } else {
                    btnToggle.className = `w-full py-4 rounded-xl font-bold text-xl transition-all shadow-sm flex items-center justify-center gap-3 bg-white text-slate-400 border border-slate-200 hover:bg-slate-50`;
                    btnToggle.innerHTML = `<i class="fas fa-power-off"></i> <span>OFF</span>`;
                }

                // Time Inputs
                document.getElementById(`time-${r}-on`).value = relayState[`${r}_on`];
                document.getElementById(`time-${r}-off`).value = relayState[`${r}_off`];
            });
        }

        // --- Realtime Listeners ---

        // 1. Listen to Sensor Data (Using SAFE PATH)
        // Path: artifacts/{appId}/public/data/sensor_logs
        const qSensor = query(
            collection(db, 'artifacts', appId, 'public', 'data', 'sensor_logs'), 
            orderBy("timestamp", "desc"), 
            limit(20)
        );
        let myChart = null;

        onSnapshot(qSensor, (snapshot) => {
            const data = [];
            snapshot.forEach(doc => data.push(doc.data()));
            if(data.length > 0) {
                document.getElementById("val-temp").innerText = data[0].temperature.toFixed(1);
                document.getElementById("val-humid").innerText = data[0].humidity.toFixed(1);
                updateChart(data.reverse());
            }
        }, (error) => {
            console.error("Sensor listener error:", error);
            // Hide error from UI but log to console
        });

        // 2. Listen to Relay Config (Using SAFE PATH)
        // Path: artifacts/{appId}/public/data/config/relays
        onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'relays'), (doc) => {
            if (doc.exists()) {
                relayState = { ...relayState, ...doc.data() };
                renderUI();
            }
        }, (error) => {
            console.error("Config listener error:", error);
        });

        // Chart Setup
        function updateChart(data) {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            const labels = data.map(d => moment(d.timestamp.toDate()).format("HH:mm"));
            const temps = data.map(d => d.temperature);
            
            if (myChart) myChart.destroy();
            
            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperature',
                        data: temps,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { display: false } } }
                }
            });
        }

        // Initial Auth
        signInAnonymously(auth).then(() => {
            document.getElementById("connection-status").innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> Online`;
            console.log("Authenticated. Using AppID:", appId);
        });

    </script>
</body>
</html>
