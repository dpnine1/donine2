<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Control (2 Relays)</title>
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Outfit', sans-serif; }
        
        /* Glassmorphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
        }

        /* Power Button Animation */
        .power-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden; }
        .power-btn:active { transform: scale(0.95); }
        .power-btn.on { 
            background: linear-gradient(135deg, #10b981 0%, #059669 100%); 
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); 
            border: none;
        }
        .power-btn.off { 
            background: #f8fafc; 
            color: #94a3b8; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Tabs */
        .tab-btn { transition: all 0.2s; }
        .tab-btn.active { background-color: #4f46e5; color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 pb-20">

    <!-- Header Background -->
    <div class="fixed top-0 left-0 w-full h-64 bg-gradient-to-r from-indigo-600 to-blue-500 rounded-b-[3rem] shadow-lg -z-10"></div>

    <div class="max-w-6xl mx-auto px-4 pt-10">
        <!-- Title & Status -->
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-10 text-white">
            <div>
                <h1 class="text-3xl font-bold tracking-tight">Smart Dashboard</h1>
                <p class="text-indigo-100 mt-1 opacity-90">ควบคุมระบบเซนเซอร์และรีเลย์ 2 ช่อง</p>
            </div>
            <div id="status-badge" class="px-4 py-2 bg-white/20 backdrop-blur-md rounded-full text-sm font-medium flex items-center gap-2 border border-white/30">
                <span class="animate-pulse">●</span> Connecting...
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- LEFT COLUMN: SENSORS (8 Cols) -->
            <div class="lg:col-span-8 flex flex-col gap-6">
                <!-- Sensor Values -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-temperature-three-quarters text-6xl text-orange-500"></i></div>
                        <p class="text-slate-500 text-sm font-semibold mb-1">TEMPERATURE</p>
                        <h2 id="latest-temp" class="text-5xl font-bold text-slate-800">-- <span class="text-2xl text-slate-400 font-light">°C</span></h2>
                    </div>
                    <div class="glass-card p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition"><i class="fa-solid fa-droplet text-6xl text-blue-500"></i></div>
                        <p class="text-slate-500 text-sm font-semibold mb-1">HUMIDITY</p>
                        <h2 id="latest-hum" class="text-5xl font-bold text-slate-800">-- <span class="text-2xl text-slate-400 font-light">%</span></h2>
                    </div>
                </div>

                <!-- Chart -->
                <div class="glass-card p-6 rounded-2xl flex-1 min-h-[350px]">
                    <h3 class="font-bold text-slate-700 mb-4">Real-time Monitor</h3>
                    <div class="relative w-full h-[300px]">
                        <canvas id="sensorChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: CONTROL PANEL (4 Cols) -->
            <div class="lg:col-span-4">
                <div class="glass-card p-6 rounded-2xl h-full flex flex-col">
                    <div class="flex items-center gap-2 mb-6">
                        <div class="w-8 h-8 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center"><i class="fa-solid fa-sliders"></i></div>
                        <h3 class="font-bold text-lg text-slate-800">Relay Control</h3>
                    </div>

                    <!-- 1. TABS (Relay Selector) -->
                    <div class="bg-slate-100 p-1 rounded-xl flex mb-6">
                        <button onclick="switchTab('relay_1')" id="tab-relay_1" class="tab-btn active flex-1 py-2.5 rounded-lg text-sm font-bold text-slate-600">Relay 1</button>
                        <button onclick="switchTab('relay_2')" id="tab-relay_2" class="tab-btn flex-1 py-2.5 rounded-lg text-sm font-bold text-slate-600">Relay 2</button>
                    </div>

                    <!-- 2. MODE SWITCH (Manual / Auto) -->
                    <div class="flex justify-between items-center mb-6 px-2">
                        <span class="text-sm font-semibold text-slate-500">Mode:</span>
                        <div class="flex bg-slate-100 rounded-lg p-1 border border-slate-200">
                            <button onclick="setMode('manual')" id="btn-manual" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-white text-indigo-600 shadow-sm">Manual</button>
                            <button onclick="setMode('auto')" id="btn-auto" class="px-4 py-1.5 rounded-md text-xs font-bold transition-all text-slate-400 hover:text-slate-600">Auto</button>
                        </div>
                    </div>

                    <!-- 3. CONTROL AREA -->
                    <div class="flex-1 relative">
                        <!-- Manual Panel -->
                        <div id="panel-manual" class="flex flex-col items-center justify-center h-full py-4 transition-all">
                            <button id="btn-relay-toggle" onclick="toggleRelay()" class="power-btn off w-32 h-32 rounded-full border-4 border-white flex items-center justify-center text-4xl shadow-lg mb-4">
                                <i class="fa-solid fa-power-off"></i>
                            </button>
                            <p id="relay-status-text" class="text-xl font-bold text-slate-300">CLOSED</p>
                        </div>

                        <!-- Auto Panel -->
                        <div id="panel-auto" class="hidden h-full flex flex-col gap-4">
                            <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                                <label class="text-xs font-bold text-green-600 uppercase mb-1 block"><i class="fa-regular fa-clock mr-1"></i> Start Time</label>
                                <input type="time" id="timer-on" onchange="updateTimer()" class="w-full text-xl font-bold text-slate-700 bg-transparent border-none p-0 focus:ring-0">
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                                <label class="text-xs font-bold text-red-500 uppercase mb-1 block"><i class="fa-regular fa-clock mr-1"></i> End Time</label>
                                <input type="time" id="timer-off" onchange="updateTimer()" class="w-full text-xl font-bold text-slate-700 bg-transparent border-none p-0 focus:ring-0">
                            </div>
                            <div class="mt-auto p-3 bg-blue-50 rounded-lg text-xs text-blue-600 leading-relaxed">
                                <i class="fa-solid fa-circle-info mr-1"></i> ระบบจะทำงานตามเวลาที่ตั้งไว้อัตโนมัติในโหมดนี้
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, query, orderBy, limit, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCO_62NI-RwdgdkANDxG71o0MJH7wd2CFE",
            authDomain: "dpcloud-67cdb.firebaseapp.com",
            projectId: "dpcloud-67cdb",
            storageBucket: "dpcloud-67cdb.firebasestorage.app",
            messagingSenderId: "207464024544",
            appId: "1:207464024544:web:7affe28fde0088a374c385"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- Variables ---
        let activeRelayId = "relay_1"; // แท็บที่เลือกอยู่ปัจจุบัน
        let relayData = {
            relay_1: { mode: 'manual', state: false, timerOn: "18:00", timerOff: "06:00" },
            relay_2: { mode: 'manual', state: false, timerOn: "18:00", timerOff: "06:00" }
        };
        let chartInstance = null; // เก็บ Chart Object

        // --- 1. สลับ Tab Relay ---
        window.switchTab = (relayId) => {
            activeRelayId = relayId;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'text-white'));
            document.getElementById(`tab-${relayId}`).classList.add('active');
            updateUI(); 
        }

        // --- 2. ฟังค่าจาก Firebase (ต้องรอ Auth ก่อน) ---
        function setupListeners() {
            ['relay_1', 'relay_2'].forEach(id => {
                onSnapshot(doc(db, "controls", id), (docSnap) => {
                    if (docSnap.exists()) {
                        relayData[id] = docSnap.data();
                        if (activeRelayId === id) updateUI();
                    } else {
                        setDoc(doc(db, "controls", id), relayData[id]).catch(e => console.error("Error creating doc:", e));
                    }
                }, (error) => {
                    console.error(`Error listening to ${id}:`, error);
                });
            });
        }

        // --- 3. อัปเดตหน้าจอ Control Panel ---
        function updateUI() {
            const data = relayData[activeRelayId];
            const btnManual = document.getElementById('btn-manual');
            const btnAuto = document.getElementById('btn-auto');
            const panelManual = document.getElementById('panel-manual');
            const panelAuto = document.getElementById('panel-auto');
            
            if (data.mode === 'manual') {
                btnManual.className = "px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-white text-indigo-600 shadow-sm";
                btnAuto.className = "px-4 py-1.5 rounded-md text-xs font-bold transition-all text-slate-400 hover:text-slate-600";
                panelManual.classList.remove('hidden');
                panelAuto.classList.add('hidden');
            } else {
                btnAuto.className = "px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-white text-indigo-600 shadow-sm";
                btnManual.className = "px-4 py-1.5 rounded-md text-xs font-bold transition-all text-slate-400 hover:text-slate-600";
                panelManual.classList.add('hidden');
                panelAuto.classList.remove('hidden');
            }

            const btn = document.getElementById('btn-relay-toggle');
            const txt = document.getElementById('relay-status-text');
            if (data.state) {
                btn.className = "power-btn on w-32 h-32 rounded-full text-white flex items-center justify-center text-5xl mb-4";
                txt.innerText = "OPEN";
                txt.className = "text-xl font-bold text-green-500";
            } else {
                btn.className = "power-btn off w-32 h-32 rounded-full border-4 border-slate-50 bg-white text-slate-300 flex items-center justify-center text-5xl shadow-md mb-4";
                txt.innerText = "CLOSED";
                txt.className = "text-xl font-bold text-slate-300";
            }

            document.getElementById('timer-on').value = data.timerOn || "00:00";
            document.getElementById('timer-off').value = data.timerOff || "00:00";
        }

        // --- 4. ฟังก์ชันสั่งงาน ---
        window.setMode = async (mode) => {
            await setDoc(doc(db, "controls", activeRelayId), { mode: mode }, { merge: true });
        };

        window.toggleRelay = async () => {
            if (relayData[activeRelayId].mode === 'auto') return;
            const newState = !relayData[activeRelayId].state;
            await setDoc(doc(db, "controls", activeRelayId), { state: newState }, { merge: true });
        };

        window.updateTimer = async () => {
            const tOn = document.getElementById('timer-on').value;
            const tOff = document.getElementById('timer-off').value;
            await setDoc(doc(db, "controls", activeRelayId), { timerOn: tOn, timerOff: tOff }, { merge: true });
        };

        // --- 5. Chart & Data Load (ย้ายมาเรียกหลังจาก Auth) ---
        function initChartAndData() {
            const ctx = document.getElementById('sensorChart').getContext('2d');
            
            const gradientTemp = ctx.createLinearGradient(0, 0, 0, 400);
            gradientTemp.addColorStop(0, 'rgba(249, 115, 22, 0.4)'); 
            gradientTemp.addColorStop(1, 'rgba(249, 115, 22, 0)');
            
            const gradientHum = ctx.createLinearGradient(0, 0, 0, 400);
            gradientHum.addColorStop(0, 'rgba(59, 130, 246, 0.4)'); 
            gradientHum.addColorStop(1, 'rgba(59, 130, 246, 0)');

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: [], 
                    datasets: [
                        { label: 'Temp (°C)', borderColor: '#f97316', backgroundColor: gradientTemp, fill: true, tension: 0.4, data: [] }, 
                        { label: 'Humid (%)', borderColor: '#3b82f6', backgroundColor: gradientHum, fill: true, tension: 0.4, data: [] }
                    ] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { position: 'top', align: 'end' } }, 
                    scales: { x: { display: false }, y: { grid: { color: '#f1f5f9' } } } 
                }
            });

            // Start Listening to Data
            const q = query(collection(db, "sensor_logs"), orderBy("timestamp", "desc"), limit(30));
            onSnapshot(q, (snap) => {
                const data = [];
                snap.forEach(d => data.push(d.data()));
                data.sort((a,b) => a.timestamp.seconds - b.timestamp.seconds);
                
                if(data.length > 0) {
                    const last = data[data.length-1];
                    document.getElementById('latest-temp').innerHTML = `${last.temperature.toFixed(1)} <span class="text-2xl text-slate-400 font-light">°C</span>`;
                    document.getElementById('latest-hum').innerHTML = `${last.humidity.toFixed(1)} <span class="text-2xl text-slate-400 font-light">%</span>`;
                    document.getElementById('status-badge').innerHTML = `<span class="text-green-400">●</span> Online`;
                    
                    chartInstance.data.labels = data.map(d => moment(d.timestamp.toDate()).format('HH:mm'));
                    chartInstance.data.datasets[0].data = data.map(d => d.temperature);
                    chartInstance.data.datasets[1].data = data.map(d => d.humidity);
                    chartInstance.update('none');
                }
            }, (error) => {
                console.error("Error reading sensor_logs:", error);
                document.getElementById('status-badge').innerHTML = `<span class="text-red-400">●</span> Error: ${error.code}`;
            });
        }

        // --- STARTUP LOGIC: FIX PERMISSION DENIED ---
        const startApp = async () => {
            try {
                // 1. Sign In First
                await signInAnonymously(auth);
                console.log("Authentication successful!");
                
                // 2. Only THEN Initialize Listeners
                setupListeners();
                initChartAndData();
                
            } catch (error) {
                console.error("Authentication Error:", error);
                document.getElementById('status-badge').innerHTML = "Auth Failed";
            }
        };

        startApp();

    </script>
</body>
</html>
