<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chainat Smart Monitor - Random Simulation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1300px; margin: 0 auto; }
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .card h2 { font-size: 1rem; margin-bottom: 15px; color: #00d2ff; }
        .val { font-size: 2.5rem; font-weight: bold; font-family: 'Courier New', monospace; text-align: center; }
        .unit { font-size: 0.9rem; opacity: 0.6; text-align: center; margin-bottom: 10px; }
        
        .t-color { color: #ff4b2b; } .h-color { color: #00d2ff; } .p-color { color: #f8ff00; }
        .clock { font-size: 3rem; color: #4ecca3; font-weight: bold; text-align: center; }
        
        .graph-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-card { height: 350px; }

        #mqtt-status { font-size: 0.7rem; float: right; }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #4ecca3; box-shadow: 0 0 10px #4ecca3; }
        .offline { background-color: #ff416c; }

        @media (max-width: 900px) { .graph-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <div class="main-grid">
        <div class="card">
            <span id="mqtt-status"><span class="dot offline" id="status-dot"></span>MQTT Offline</span>
            <h2>üå°Ô∏è ESP32 Sensor (Live)</h2>
            <div style="display: flex; justify-content: space-around;">
                <div><div class="val t-color" id="txt-temp">--</div><div class="unit">¬∞C Temp</div></div>
                <div><div class="val h-color" id="txt-humi">--</div><div class="unit">% Humidity</div></div>
            </div>
        </div>

        <div class="card">
            <h2>üí® PM2.5 (Simulated)</h2>
            <div class="val p-color" id="txt-pm25">--</div>
            <div class="unit">¬µg/m¬≥ (Random Walk)</div>
            <div id="pm25-status" style="text-align: center; font-size: 0.8rem; font-weight: bold; border-radius: 5px; padding: 4px;">‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>

        <div class="card">
            <h2>‚è∞ Time</h2>
            <div class="clock" id="clock">00:00:00</div>
            <div id="date" style="text-align: center; opacity: 0.5; font-size: 0.8rem;">--</div>
        </div>
    </div>

    <div class="graph-grid">
        <div class="card chart-card">
            <h2>üìä ESP32 Data (MQTT)</h2>
            <div style="height: 260px;"><canvas id="chartESP32"></canvas></div>
        </div>
        <div class="card chart-card">
            <h2>üìä PM2.5 Trend (Simulation)</h2>
            <div style="height: 260px;"><canvas id="chartPM25"></canvas></div>
        </div>
    </div>
</div>

<script>
    // --- 1. Clock ---
    function updateClock() {
        const now = new Date();
        document.getElementById('clock').textContent = now.toLocaleTimeString('th-TH');
        document.getElementById('date').textContent = now.toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long' });
    }
    setInterval(updateClock, 1000);

    // --- 2. Charts Setup ---
    const MAX_DATA = 15;
    const commonOptions = {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { labels: { color: 'white', font: { size: 10 } } } },
        scales: { 
            x: { ticks: { color: '#888', font: { size: 10 } }, grid: { display: false } },
            y: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.05)' } }
        }
    };

    const chartESP = new Chart(document.getElementById('chartESP32'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'Temp', data: [], borderColor: '#ff4b2b', yAxisID: 'y', tension: 0.3 },
                { label: 'Humi', data: [], borderColor: '#00d2ff', yAxisID: 'y1', tension: 0.3 }
            ]
        },
        options: { ...commonOptions, scales: { ...commonOptions.scales, y: { position: 'left' }, y1: { position: 'right', grid: { drawOnChartArea: false } } } }
    });

    const chartPM = new Chart(document.getElementById('chartPM25'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{ label: 'PM2.5 (Sim)', data: [], backgroundColor: 'rgba(248, 255, 0, 0.4)', borderColor: '#f8ff00', borderWidth: 1 }]
        },
        options: commonOptions
    });

    // --- 3. PM2.5 Random Logic ---
    let currentPM25 = 25; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà 25
    function simulatePM25() {
        // ‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö Random Walk (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡∏ô‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡πÇ‡∏î‡∏î)
        const change = (Math.random() * 4) - 2; // ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á -2 ‡∏ñ‡∏∂‡∏á +2
        currentPM25 += change;
        
        // ‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á 10 - 150
        if (currentPM25 < 10) currentPM25 = 10;
        if (currentPM25 > 150) currentPM25 = 150;

        const val = Math.round(currentPM25);
        document.getElementById('txt-pm25').textContent = val;
        
        const st = document.getElementById('pm25-status');
        if(val <= 25) { st.textContent = "‡∏î‡∏µ‡∏°‡∏≤‡∏Å"; st.style.color = "#27ae60"; }
        else if(val <= 50) { st.textContent = "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á"; st.style.color = "#f39c12"; }
        else { st.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏°‡∏µ‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û"; st.style.color = "#ff416c"; }
        
        return val;
    }

    function updateCharts(time, t, h, p) {
        [chartESP, chartPM].forEach(c => {
            if (c.data.labels.length >= MAX_DATA) {
                c.data.labels.shift();
                c.data.datasets.forEach(d => d.data.shift());
            }
            c.data.labels.push(time);
        });
        chartESP.data.datasets[0].data.push(t);
        chartESP.data.datasets[1].data.push(h);
        chartPM.data.datasets[0].data.push(p);
        chartESP.update(); chartPM.update();
    }

    // --- 4. MQTT Connection ---
    const mqttCfg = {
        host: "1775d011329846b5a98c94a70f743969.s1.eu.hivemq.cloud",
        port: 8884,
        user: "dpnine", pass: "nayNAY08", topic: "home/sensor"
    };

    const client = new Paho.MQTT.Client(mqttCfg.host, mqttCfg.port, "web_sim_" + Math.random().toString(16).substr(2, 5));
    
    client.onMessageArrived = (msg) => {
        const payload = JSON.parse(msg.payloadString);
        const now = new Date().toLocaleTimeString('th-TH', { hour12: false });
        const pVal = simulatePM25(); // ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà MQTT ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
        
        document.getElementById('txt-temp').textContent = payload.temp;
        document.getElementById('txt-humi').textContent = payload.humidity;
        
        updateCharts(now, payload.temp, payload.humidity, pVal);
    };

    client.onConnectionLost = () => {
        document.getElementById('status-dot').className = "dot offline";
        setTimeout(conn, 5000);
    };

    function conn() {
        client.connect({
            onSuccess: () => {
                document.getElementById('status-dot').className = "dot online";
                document.getElementById('mqtt-status').lastChild.textContent = " Online";
                client.subscribe(mqttCfg.topic);
            },
            onFailure: () => setTimeout(conn, 5000),
            userName: mqttCfg.user, password: mqttCfg.pass, useSSL: true
        });
    }
    conn();
</script>
</body>
</html>
